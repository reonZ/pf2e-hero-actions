(()=>{var fe=Object.defineProperty;var r=(e,t)=>fe(e,"name",{value:t,configurable:!0});var l="pf2e-hero-actions";function b(e){return game.settings.get(l,e)}r(b,"getSetting");function C(e,t){return game.settings.set(l,e,t)}r(C,"setSetting");function s(...e){let[t,n]=e;return t=`${l}.${t}`,n?game.i18n.format(t,n):game.i18n.localize(t)}r(s,"localize");function W(e){game.socket.on(`module.${l}`,e)}r(W,"socketOn");function v(e){game.socket.emit(`module.${l}`,e)}r(v,"socketEmit");function y(...e){return e=e.filter(t=>typeof t=="string"),`modules/${l}/templates/${e.join("/")}`}r(y,"templatePath");function w(e,t,n){return e.getFlag(l,t)??n}r(w,"getFlag");function g(e,t,n){return e.setFlag(l,t,n)}r(g,"setFlag");function h(e){let t=r((...n)=>s(`${e}.${n[0]}`,n[1]),"fn");return Object.defineProperties(t,{warn:{value:(...n)=>d(`${e}.${n[0]}`,n[1],n[2]),enumerable:!1,configurable:!1},info:{value:(...n)=>_(`${e}.${n[0]}`,n[1],n[2]),enumerable:!1,configurable:!1},error:{value:(...n)=>p(`${e}.${n[0]}`,n[1],n[2]),enumerable:!1,configurable:!1},has:{value:n=>hasLocalization(`${e}.${n}`),enumerable:!1,configurable:!1},path:{value:n=>localizePath(`${e}.${n}`),enumerable:!1,configurable:!1},template:{value:(n,{hash:a})=>t(n,a),enumerable:!1,configurable:!1}}),t}r(h,"subLocalize");function R(e,t,n,a){let i=typeof t=="string"?t:"info",o=typeof t=="object"?t:typeof n=="object"?n:void 0,c=typeof t=="boolean"?t:typeof n=="boolean"?n:a??!1;ui.notifications.notify(s(e,o),i,{permanent:c})}r(R,"notify");function d(...e){let[t,n,a]=e;R(t,"warning",n,a)}r(d,"warn");function _(...e){let[t,n,a]=e;R(t,"info",n,a)}r(_,"info");function p(...e){let[t,n,a]=e;R(t,"error",n,a)}r(p,"error");function T(e,t){return t?`@UUID[${e}]{${t}}`:`@UUID[${e}]`}r(T,"chatUUID");var pe=/@UUID\[([\w\.]+)\]/;function V(e){if(e.type===CONST.TABLE_RESULT_TYPES.TEXT)return pe.exec(e.text)?.[1];if(e.type===CONST.TABLE_RESULT_TYPES.DOCUMENT)return`${e.documentCollection}.${e.documentId}`;if(e.type===CONST.TABLE_RESULT_TYPES.COMPENDIUM)return`Compendium.${e.documentCollection}.${e.documentId}`}r(V,"documentUuidFromTableResult");function Z(e,t=!1){return t?game.users.find(n=>n.active&&n.character===e):game.users.find(n=>n.character===e)}r(Z,"getCharacterOwner");function Q(e,t=!1){return t?game.users.find(n=>n.active&&e.testUserPermission(n,"OWNER")):game.users.find(n=>e.testUserPermission(n,"OWNER"))}r(Q,"getOwner");function K(){return game.user===game.users.activeGM}r(K,"isFirstGM");async function ee(e){let{sender:t,receiver:n}=e,a=game.actors.get(t.cid),i=game.actors.get(n.cid);if(!a||!i){P(e);return}let o=`<p>${s("trade-request.header",{sender:a.name,receiver:i.name})}</p>`;o+=`<p>${s("trade-request.give",{give:T(t.uuid)})}</p>`,o+=`<p>${s("trade-request.want",{want:T(n.uuid)})}</p>`,o+=`<p style="margin-bottom: 1em;">${s("trade-request.accept")}</p>`,await Dialog.confirm({title:s("trade-request.title"),content:await TextEditor.enrichHTML(o,{async:!0})})?ne(e):me(e)}r(ee,"onTradeRequest");async function z(e){let{sender:t,receiver:n}=e,a=game.actors.get(t.cid),i=game.actors.get(n.cid);if(!a||!i){P(e);return}let o=w(a,"heroActions")??[],c=w(i,"heroActions")??[],u=o.findIndex(M=>M.uuid===t.uuid),f=c.findIndex(M=>M.uuid===n.uuid);if(u===-1||f===-1){P(e);return}let X=o.splice(u,1)[0],J=c.splice(f,1)[0];o.push(J),c.push(X),g(a,"heroActions",o),g(i,"heroActions",c);let de=T(X.uuid),ue=T(J.uuid),Y=`<div style="line-height: 1.6">${s("trade-success.offer",{offer:de})}</div>`;Y+=`<div style="line-height: 1.6">${s("trade-success.receive",{receive:ue})}</div>`,ChatMessage.create({flavor:`<h4 class="action">${s("trade-success.header",{name:i.name})}</h4>`,content:Y,speaker:ChatMessage.getSpeaker({actor:a})})}r(z,"onTradeAccepted");function F(e){p("trade-error")}r(F,"onTradeError");async function j({receiver:e}){let t=game.actors.get(e.cid);d("trade-rejected",{name:t.name},!0)}r(j,"onTradeRejected");function te(e){if(e.receiver.id===game.user.id){ne(e);return}v({...e,type:"trade-request"})}r(te,"sendTradeRequest");function ne(e){if(game.user.isGM){z(e);return}v({...e,type:"trade-accept"})}r(ne,"acceptRequest");function me(e){if(e.sender.id===game.user.id){j(e);return}v({...e,type:"trade-reject"})}r(me,"rejectRequest");function P({sender:e,receiver:t},n="trade-error"){let a=new Set([e.id,t.id]);a.has(game.user.id)&&(a.delete(game.user.id),F(n)),a.size&&v({type:"trade-error",users:Array.from(a),error:n})}r(P,"sendTradeError");var k=class extends Application{constructor(t){super({id:`pf2e-hero-actions-trade-${t.id}`}),this._actor=t}static get defaultOptions(){return mergeObject(super.defaultOptions,{title:s("templates.trade.title"),template:y("trade.hbs"),width:600,height:"auto"})}get actor(){return this._actor}get target(){return this._target}set target(t){if(!t){p("templates.trade.no-target");return}t!==this._target&&(delete this.target?.apps?.[this.appId],this._target=t,this.render())}getData(t){return mergeObject(super.getData(),{actor:this.actor,target:this.target,targets:game.actors.filter(n=>n.type==="character"&&n.id!==this.actor.id&&n.hasPlayerOwner),actions:m(this.actor),targetActions:this.target?m(this.target):[],i18n:h("templates.trade")})}activateListeners(t){super.activateListeners(t),t.find('select[name="target"]').on("change",this.#n.bind(this)),t.find('[data-action="description"]').on("click",this.#t.bind(this)),t.find('[data-action="trade"]').on("click",this.#e.bind(this)),t.find('[data-action="cancel"]').on("click",()=>this.close())}render(t,n){return this.actor.apps[this.appId]=this,this.target&&(this.target.apps[this.appId]=this),super.render(t,n)}async close(t){await super.close(t),delete this.actor.apps?.[this.appId],delete this.target?.apps?.[this.appId]}#e(){if(!this.target){d("templates.trade.no-target");return}let t=this.element.find('[name="action"]:checked').val(),n=this.element.find('[name="targetAction"]:checked').val();if(typeof t!="string"||typeof n!="string"){d("templates.trade.no-select");return}let a=Z(this.target,!0)??Q(this.target,!0)??game.users.activeGM;if(!a){d("templates.trade.no-user");return}te({sender:{id:game.user.id,cid:this.actor.id,uuid:t},receiver:{id:a.id,cid:this.target.id,uuid:n}}),this.close()}async#t(t){let n=$(t.currentTarget).siblings("input").val();(await fromUuid(n))?.sheet.render(!0)}#n(t){let n=t.currentTarget.value;this.target=game.actors.get(n)}};r(k,"Trade");var ge="Compendium.pf2e.journals.JournalEntry.BSp4LUSaOmUyjBko",x="Compendium.pf2e.rollable-tables.RollTable.zgZoI7h0XjjJrrNK";async function ae(e){if(!e)return;let t=await fromUuid(e);return t&&t instanceof RollTable?t:void 0}r(ae,"getTableFromUuid");async function he(){return ae(x)}r(he,"getDefaultCompendiumTable");function q(){return game.tables.find(e=>e.getFlag("core","sourceId")===x)}r(q,"getDefaultWorldTable");async function be(){return ae(b("tableUUID"))}r(be,"getCustomTable");async function ye(){return await be()??q()??await he()}r(ye,"getDeckTable");function m(e){return w(e,"heroActions")??[]}r(m,"getHeroActions");async function A(e){let t=await fromUuid(e);if(!t)return;let n=t instanceof JournalEntry?t:t.parent,a=t instanceof JournalEntry?t.pages.contents[0]:t,i=a?.text.content;if(i)return n.uuid===ge&&(i=i.replace(/^<p>/,"<p><strong>Trigger</strong> ")),{name:a.name,description:i}}r(A,"getHeroActionDetails");async function D(e,t){let n=await A(t);if(!n)return p("details.missing");ChatMessage.create({content:`<h2>${n.name}</h2>${n.description}`,speaker:ChatMessage.getSpeaker({actor:e})})}r(D,"sendActionToChat");async function E(e,t){t=typeof t=="string"?[t]:t;let n=m(e),a=[];for(let c of t){let u=n.findIndex(f=>f.uuid===c);u!==-1&&(a.push(n[u]),n.splice(u,1))}re(e,n);let{content:i,size:o}=ie(a);ChatMessage.create({flavor:`<h4 class="action">${s("actions-discard.header",{nb:o})}</h4>`,content:i,speaker:ChatMessage.getSpeaker({actor:e})})}r(E,"discardHeroActions");function re(e,t){return g(e,"heroActions",t)}r(re,"setHeroActions");async function N(){let e=await ye();if(!e)return p("table.drawError",!0),null;if(!e.formula)if(game.user.isGM){if(e.compendium)return p("table.noFormulaCompendium",!0),null;await e.normalize()}else return p("table.noFormula",!0),null;e.replacement===!1&&(e.results.some(i=>!i.drawn)||await e.resetResults());let t=(await e.draw({displayChat:!1})).results[0];if(!t)return;let n=V(t);if(n)return{uuid:n,name:await we(t,n)}}r(N,"drawHeroAction");var Te=/@UUID\[[\w\.]+\]{([\w -]+)}/;async function we(e,t){return e.type!==CONST.TABLE_RESULT_TYPES.TEXT?e.text:Te.exec(e.text)?.[1]??(t&&(await fromUuid(t))?.name)}r(we,"getLabelfromTableResult");async function U(e){let t=m(e),n=e.heroPoints.value-t.length,a=[];for(let u=0;u<n;u++){let f=await N();if(f!==void 0){if(f===null)return;t.push(f),a.push(f)}}if(!a.length)return;re(e,t);let{content:i,size:o}=ie(a),c={flavor:`<h4 class="action">${s("actions-draw.header",{nb:o})}</h4>`,content:i,speaker:ChatMessage.getSpeaker({actor:e})};b("private")&&(c.type=CONST.CHAT_MESSAGE_TYPES.ROLL,c.rollMode=CONST.DICE_ROLL_MODES.PRIVATE),ChatMessage.create(c)}r(U,"drawHeroActions");async function S(e,t){let n=e.heroPoints.value;if(n<1)return d("use.noPoints");let a=m(e),i=a.findIndex(c=>c.uuid===t);if(i===-1)return;let o=await A(t);o||p("use.noDetails"),a.splice(i,1),o?(e.update({["system.resources.heroPoints.value"]:n-1,[`flags.${l}.heroActions`]:a}),ChatMessage.create({flavor:`<h4 class="action">${s("actions-use.header")}</h4>`,content:`<h2>${o.name}</h2>${o.description}`,speaker:ChatMessage.getSpeaker({actor:e})})):g(e,"heroActions",a)}r(S,"useHeroAction");function H(e){let t=w(e,"heroActions");if(!t||!t.length){d("no-action");return}let n=t.length-e.heroPoints.value;if(n>0){d("no-points",{nb:n.toString()});return}new k(e).render(!0)}r(H,"tradeHeroAction");function ie(e){let t=e.map(({uuid:n,name:a})=>T(n,a));return{content:t.map(n=>`<div style="line-height: 1.6;">${n}</div>`).join(""),size:t.length}}r(ie,"chatActions");async function oe(e,t){let n=e.actor;n.pack||!n.id||!game.actors.has(n.id)||(await Ae(t,n),ve(t,n))}r(oe,"renderCharacterSheetPF2e");async function Ae(e,t){let n=m(t),a=t.heroPoints.value-n.length,i=t.isOwner,o=h("templates.heroActions"),c=await renderTemplate(y("sheet.hbs"),{owner:i,list:n,canUse:a>=0&&i,canDraw:a>0&&i,canTrade:b("trade"),mustDiscard:a<0,diff:Math.abs(a),i18n:(u,{hash:f})=>o(u,f)});e.find(".sheet-body .sheet-content [data-tab=actions] .tab-content .actions-panels [data-tab=encounter] > .strikes-list:not(.skill-action-list)").first().after(c)}r(Ae,"addHeroActions");function ve(e,t){let n=e.find(".tab.actions .heroActions-list");n.find("[data-action=draw]").on("click",a=>$e(t,a)),n.find("[data-action=expand]").on("click",ke),n.find("[data-action=use]").on("click",a=>Ee(t,a)),n.find("[data-action=display]").on("click",a=>xe(t,a)),n.find("[data-action=discard]").on("click",Ce),n.find("[data-action=discard-selected]").on("click",()=>De(t,e)),e.find("[data-action=hero-actions-trade]").on("click",()=>H(t))}r(ve,"addEvents");async function ke(e){e.preventDefault();let t=$(e.currentTarget).closest(".action"),n=t.find(".item-summary");if(!n.hasClass("loaded")){let a=t.attr("data-uuid"),i=await A(a);if(!i)return;let o=await TextEditor.enrichHTML(i.description,{async:!0});n.find(".item-description").html(o),n.addClass("loaded")}t.toggleClass("expanded")}r(ke,"onClickHeroActionExpand");async function xe(e,t){t.preventDefault();let n=$(t.currentTarget).closest(".action").attr("data-uuid");D(e,n)}r(xe,"onClickHeroActionDisplay");function Ce(e){e.preventDefault();let t=$(e.currentTarget).closest(".action"),n=t.closest(".heroActions-list");t.toggleClass("discarded");let a=Number(n.attr("data-discard")??"0"),i=n.find(".action.discarded");n.toggleClass("discardable",i.length===a)}r(Ce,"onClickHeroActionDiscard");async function De(e,t){let a=t.find(".tab.actions .heroActions-list .action.discarded").toArray().map(i=>i.dataset.uuid);E(e,a)}r(De,"onClickHeroActionsDiscard");async function $e(e,t){t.preventDefault(),U(e)}r($e,"onClickHeroActionsDraw");async function Ee(e,t){t.preventDefault();let n=$(t.currentTarget).closest(".action").attr("data-uuid");S(e,n)}r(Ee,"onClickHeroActionUse");var Ue="systems/pf2e/icons/features/feats/heroic-recovery.webp",I=h("templates.createTable.choice"),se=h("templates.createTable.default.confirm"),O=h("templates.removeActions");async function ce(){let e=y("dialogs/create-table.hbs"),t={yes:{label:I("create"),icon:'<i class="fas fa-border-all"></i>',callback:i=>{let o=i.find('.window-content input[name="type"]:checked').val(),c=i.find('.window-content input[name="draw"]:checked').val()==="unique";return{type:o,unique:c}}},no:{label:I("cancel"),icon:'<i class="fas fa-times"></i>',callback:()=>null}},n={content:await renderTemplate(e,{i18n:I}),title:I("title"),buttons:t,default:"yes",close:()=>null},a=await Dialog.wait(n,void 0,{id:"pf2e-hero-actions-create-table"});a&&(a.type==="default"?Ie(a.unique):Oe(a.unique))}r(ce,"createTable");async function le(){let e=y("dialogs/remove-actions.hbs"),t={yes:{label:O("remove"),icon:'<i class="fas fa-trash"></i>',callback:i=>i.find<HTMLInputElement>'input[name="actor"]:checked'.toArray().map(o=>game.actors.get(o.value)).filter(o=>o)},no:{label:O("cancel"),icon:'<i class="fas fa-times"></i>',callback:()=>[]}},n={content:await renderTemplate(e,{actors:game.actors.filter(i=>i.type==="character"),i18n:O}),title:O("title"),buttons:t,default:"yes",render:i=>{i.on("change",'input[name="all"]',()=>Se(i)),i.on("change",'input[name="actor"]',()=>He(i))},close:()=>[]},a=await Dialog.wait(n,void 0,{id:"pf2e-hero-actions-remove-actions"});if(!a.length)return d("templates.removeActions.noSelection");for(let i of a)await g(i,"heroActions",[]);_("templates.removeActions.removed")}r(le,"removeHeroActions");function Se(e){let t=e.find('input[name="all"]')[0].checked;e.find('input[name="actor"]').prop("checked",t)}r(Se,"removeActionsToggleAll");function He(e){let t=e.find('input[name="actor"]'),n=t.filter(":checked"),a=e.find('input[name="all"]');t.length===n.length?(a.prop("checked",!0).prop("indeterminate",!1),t.prop("checked",!0)):n.length?a.prop("checked",!1).prop("indeterminate",!0):(a.prop("checked",!1).prop("indeterminate",!1),t.prop("checked",!1))}r(He,"removeActionsToggleActor");async function Ie(e){let t=await q();if(t&&await Dialog.confirm({title:se("title"),content:se("content")})){let a=G(e);return await t.update(a),B(t,!0)}t=await Le(e),await B(t)}r(Ie,"createDefaultTable");async function Oe(e){let t=await Me(e);await B(t),t.sheet?.render(!0)}r(Oe,"createCustomTable");async function B(e,t=!1){t&&await e.normalize(),await C("tableUUID",e.uuid)}r(B,"setTable");function G(e=!0,t){let n={name:s("table.name"),replacement:!e,img:Ue,description:s("table.description"),flags:{core:{sourceId:x}}};return t?mergeObject(deepClone(t._source),n):n}r(G,"getTableSource");async function Le(e=!0){let t=await fromUuid(x),n=G(e,t);return RollTable.create(n,{temporary:!1})}r(Le,"createDefautActionsTable");function Me(e=!0){let t=G(e);return RollTable.create(t,{temporary:!1})}r(Me,"createCustomActionsTable");Hooks.once("init",()=>{L({name:"tableUUID",type:String,default:""}),L({name:"trade",type:Boolean,default:!1,onChange:Pe}),L({name:"private",type:Boolean,default:!1}),L({name:"migrated",type:Number,default:0,config:!1})});Hooks.once("ready",async()=>{W(Re);let e=game.modules.get(l);e.api={getHeroActions:m,useHeroAction:S,getHeroActionDetails:A,drawHeroAction:N,drawHeroActions:U,sendActionToChat:D,discardHeroActions:E,tradeHeroAction:H},game.user.isGM&&(e.api.createTable=ce,e.api.removeHeroActions=le,await _e())});Hooks.on("renderCharacterSheetPF2e",oe);function Re(e){switch(e.type){case"trade-reject":if(e.sender.id!==game.user.id)return;j(e);break;case"trade-accept":if(!K())return;z(e);break;case"trade-request":if(e.receiver.id!==game.user.id)return;ee(e);break;case"trade-error":if(!e.users.includes(game.user.id))return;F(e.error);break}}r(Re,"onSocket");async function _e(){(b("migrated")??0)<1&&ChatMessage.create({content:s("migration.system-change"),whisper:game.user.id}),C("migrated",1)}r(_e,"manageMigrations");function L(e){let t=e.name;e.scope=e.scope??"world",e.config=e.config??!0,e.config&&(e.name=`${l}.settings.${t}.name`,e.hint=`${l}.settings.${t}.hint`),game.settings.register(l,t,e)}r(L,"registerSetting");function Pe(){Object.values(ui.windows).forEach(e=>{e instanceof ActorSheet&&e.actor.type==="character"&&e.render(!0)})}r(Pe,"refreshSheets");})();
//# sourceMappingURL=main.js.map
