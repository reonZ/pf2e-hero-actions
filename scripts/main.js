(()=>{"use strict";let e="",t="module";function n(e,t,n,a){const i="string"==typeof t?t:"info",r="object"==typeof t?t:"object"==typeof n?n:void 0,c="boolean"==typeof t?t:"boolean"==typeof n?n:a??!1;ui.notifications.notify(o(e,r),i,{permanent:c})}function a(...e){const[t,a,i]=e;n(t,"warning",a,i)}function i(...e){const[t,a,i]=e;n(t,"info",a,i)}function r(...e){const[t,a,i]=e;n(t,"error",a,i)}function o(...t){let[n,a]=t;return n=`${e}.${n}`,a?game.i18n.format(n,a):game.i18n.localize(n)}function c(t){const n=(...e)=>o(`${t}.${e[0]}`,e[1]);return Object.defineProperties(n,{warn:{value:(...e)=>a(`${t}.${e[0]}`,e[1],e[2]),enumerable:!1,configurable:!1},info:{value:(...e)=>i(`${t}.${e[0]}`,e[1],e[2]),enumerable:!1,configurable:!1},error:{value:(...e)=>r(`${t}.${e[0]}`,e[1],e[2]),enumerable:!1,configurable:!1},has:{value:n=>function(t){return game.i18n.has(`${e}.${t}`,!1)}(`${t}.${n}`),enumerable:!1,configurable:!1},path:{value:n=>function(t){return`${e}.${t}`}(`${t}.${n}`),enumerable:!1,configurable:!1},template:{value:(e,{hash:t})=>n(e,t),enumerable:!1,configurable:!1}}),n}function s(){return t=e,game.modules.get(t);var t}function u(...t){return`${e}.settings.${t.join(".")}`}function d(...t){return`flags.${e}.${t.join("/")}`}function l(...n){return n=n.filter((e=>"string"==typeof e)),`${t}s/${e}/templates/${n.join("/")}`}function f(t){return game.settings.get(e,t)}function p(t,n){return game.settings.set(e,t,n)}function g(t){const n=t.name;t.scope=t.scope??"world",t.config=t.config??!1,t.config&&(t.name=u(n,"name"),t.hint=u(n,"hint")),Array.isArray(t.choices)&&(t.choices=t.choices.reduce(((e,t)=>(e[t]=u(n,"choices",t),e)),{})),game.settings.register(e,n,t)}function m(t){game.socket.emit(`module.${e}`,t)}function h(t,n,a){return t.getFlag(e,n)??a}function y(t,n,a){return t.setFlag(e,n,a)}function v(e,t){return t?`@UUID[${e}]{${t}}`:`@UUID[${e}]`}const b=/@UUID\[([\w\.]+)\]/;async function w(e){const{sender:t,receiver:n}=e,a=game.actors.get(t.cid),i=game.actors.get(n.cid);if(!a||!i)return void C(e);const r=h(a,"heroActions")??[],c=h(i,"heroActions")??[],s=r.findIndex((e=>e.uuid===t.uuid)),u=c.findIndex((e=>e.uuid===n.uuid));if(-1===s||-1===u)return void C(e);const d=r.splice(s,1)[0],l=c.splice(u,1)[0];r.push(l),c.push(d),y(a,"heroActions",r),y(i,"heroActions",c);let f=`<div>${o("trade-success.offer",{offer:v(d.uuid)})}</div>`;f+=`<div>${o("trade-success.receive",{receive:v(l.uuid)})}</div>`,ChatMessage.create({flavor:`<h4 class="action">${o("trade-success.header",{name:i.name})}</h4>`,content:f,speaker:ChatMessage.getSpeaker({actor:a})})}async function T({receiver:e}){a("trade-rejected",{name:game.actors.get(e.cid).name},!0)}function k(e){r("trade-error")}function A(e){game.user.isGM?w(e):m({...e,type:"trade-accept"})}function C({sender:e,receiver:t},n="trade-error"){const a=new Set([e.id,t.id]);a.has(game.user.id)&&(a.delete(game.user.id),k()),a.size&&m({type:"trade-error",users:Array.from(a),error:n})}class Trade extends Application{_actor;_target;constructor(e){super({id:`pf2e-hero-actions-trade-${e.id}`}),this._actor=e}static get defaultOptions(){return mergeObject(super.defaultOptions,{title:o("templates.trade.title"),template:l("trade.hbs"),width:600,height:"auto"})}get actor(){return this._actor}get target(){return this._target}set target(e){e?e!==this._target&&(delete this.target?.apps?.[this.appId],this._target=e,this.render()):r("templates.trade.no-target")}getData(e){return mergeObject(super.getData(),{actor:this.actor,target:this.target,targets:game.actors.filter((e=>"character"===e.type&&e.id!==this.actor.id&&e.hasPlayerOwner)),actions:I(this.actor),targetActions:this.target?I(this.target):[],i18n:c("templates.trade")})}activateListeners(e){super.activateListeners(e),e.find('select[name="target"]').on("change",this.#e.bind(this)),e.find('[data-action="description"]').on("click",this.#t.bind(this)),e.find('[data-action="trade"]').on("click",this.#n.bind(this)),e.find('[data-action="cancel"]').on("click",(()=>this.close()))}render(e,t){return this.actor.apps[this.appId]=this,this.target&&(this.target.apps[this.appId]=this),super.render(e,t)}async close(e){await super.close(e),delete this.actor.apps?.[this.appId],delete this.target?.apps?.[this.appId]}#n(){if(!this.target)return void a("templates.trade.no-target");const e=this.element.find('[name="action"]:checked').val(),t=this.element.find('[name="targetAction"]:checked').val();if("string"!=typeof e||"string"!=typeof t)return void a("templates.trade.no-select");let n=function(e,t=!1){return t?game.users.find((t=>t.active&&t.character===e)):game.users.find((t=>t.character===e))}(this.target,!0)??function(e,t=!1){return t?game.users.find((t=>t.active&&e.testUserPermission(t,"OWNER"))):game.users.find((t=>e.testUserPermission(t,"OWNER")))}(this.target,!0)??game.users.find((e=>e.active&&e.isGM));var i;n?((i={sender:{id:game.user.id,cid:this.actor.id,uuid:e},receiver:{id:n.id,cid:this.target.id,uuid:t}}).receiver.id!==game.user.id?m({...i,type:"trade-request"}):A(i),this.close()):a("templates.trade.no-user")}async#t(e){const t=$(e.currentTarget).siblings("input").val(),n=await fromUuid(t);n?.sheet.render(!0)}#e(e){const t=e.currentTarget.value;this.target=game.actors.get(t)}}const S="Compendium.pf2e.journals.JournalEntry.BSp4LUSaOmUyjBko",E="Compendium.pf2e.rollable-tables.RollTable.zgZoI7h0XjjJrrNK",U="systems/pf2e/icons/features/feats/heroic-recovery.webp";async function D(e){if(!e)return;const t=await fromUuid(e);return t&&t instanceof RollTable?t:void 0}function M(){return game.tables.find((e=>e.getFlag("core","sourceId")===E))}function I(e){return h(e,"heroActions")??[]}async function O(e,t){const n=e.heroPoints.value;if(n<1)return a("use.noPoints");const i=I(e),c=i.findIndex((e=>e.uuid===t));if(-1===c)return;const s=await _(t);s||r("use.noDetails"),i.splice(c,1),s?(e.update({"system.resources.heroPoints.value":n-1,[d("heroActions")]:i}),ChatMessage.create({flavor:`<h4 class="action">${o("actions-use.header")}</h4>`,content:`<h2>${s.name}</h2>${s.description}`,speaker:ChatMessage.getSpeaker({actor:e})})):y(e,"heroActions",i)}async function _(e){let t=await fromUuid(e);if(!t)return;const n=t instanceof JournalEntry?t:t.parent,a=t instanceof JournalEntry?t.pages.contents[0]:t;let i=a?.text.content;return i?(n.uuid===S&&(i=i.replace(/^<p>/,"<p><strong>Trigger</strong> ")),{name:a.name,description:i}):void 0}function j(e,t){return y(e,"heroActions",t)}function P(e=!0,t){const n={name:o("table.name"),replacement:!e,img:U,description:o("table.description"),flags:{core:{sourceId:E}}};return t?mergeObject(duplicate(t._source),n):n}async function L(){const e=await async function(){return await async function(){return D(f("tableUUID"))}()??M()??await async function(){return D(E)}()}();if(!e)return r("table.drawError",!0),null;if(!e.formula){if(!game.user.isGM)return r("table.noFormula",!0),null;if(e.compendium)return r("table.noFormulaCompendium",!0),null;await e.normalize()}!1===e.replacement&&(e.results.some((e=>!e.drawn))||await e.resetResults());const t=(await e.draw({displayChat:!1})).results[0];if(!t)return;const n=(a=t).type===CONST.TABLE_RESULT_TYPES.TEXT?b.exec(a.text)?.[1]:a.type===CONST.TABLE_RESULT_TYPES.DOCUMENT?`${a.documentCollection}.${a.documentId}`:a.type===CONST.TABLE_RESULT_TYPES.COMPENDIUM?`Compendium.${a.documentCollection}.${a.documentId}`:void 0;var a;return n?{uuid:n,name:await H(t,n)}:void 0}const x=/@UUID\[[\w\.]+\]{([\w -]+)}/;async function H(e,t){if(e.type!==CONST.TABLE_RESULT_TYPES.TEXT)return e.text;const n=x.exec(e.text)?.[1];return n??(t&&(await fromUuid(t))?.name)}async function R(e){const t=I(e),n=e.heroPoints.value-t.length,a=[];for(let e=0;e<n;e++){const e=await L();if(void 0!==e){if(null===e)return;t.push(e),a.push(e)}}if(!a.length)return;j(e,t);const i=a.map((e=>v(e.uuid,e.name))),r={flavor:`<h4 class="action">${o("actions-draw.header",{nb:i.length})}</h4>`,content:i.map((e=>`<div>${e}</div>`)).join(""),speaker:ChatMessage.getSpeaker({actor:e})};f("private")&&(r.type=CONST.CHAT_MESSAGE_TYPES.ROLL,r.rollMode=CONST.DICE_ROLL_MODES.PRIVATE),ChatMessage.create(r)}async function N(e,t){const n=await _(t);if(!n)return r("details.missing");ChatMessage.create({content:`<h2>${n.name}</h2>${n.description}`,speaker:ChatMessage.getSpeaker({actor:e})})}async function q(e,t){t="string"==typeof t?[t]:t;const n=I(e),a=[];for(const e of t){const t=n.findIndex((t=>t.uuid===e));-1!==t&&(a.push(n[t]),n.splice(t,1))}j(e,n);const i=a.map((e=>v(e.uuid,e.name)));ChatMessage.create({flavor:`<h4 class="action">${o("actions-discard.header",{nb:i.length})}</h4>`,content:i.map((e=>`<div>${e}</div>`)).join(""),speaker:ChatMessage.getSpeaker({actor:e})})}function B(e){const t=h(e,"heroActions");if(!t||!t.length)return void a("no-action");const n=t.length-e.heroPoints.value;n>0?a("no-points",{nb:n.toString()}):new Trade(e).render(!0)}const G=c("templates.createTable.choice"),F=c("templates.createTable.default.confirm"),z=c("templates.removeActions");async function Y(){const e=l("dialogs/remove-actions.hbs"),t={yes:{label:z("remove"),icon:'<i class="fas fa-trash"></i>',callback:e=>e.find('input[name="actor"]:checked').toArray().map((e=>game.actors.get(e.value))).filter((e=>e))},no:{label:z("cancel"),icon:'<i class="fas fa-times"></i>',callback:()=>[]}},n={content:await renderTemplate(e,{actors:game.actors.filter((e=>"character"===e.type)),i18n:z}),title:z("title"),buttons:t,default:"yes",render:e=>{e.on("change",'input[name="all"]',(()=>function(e){const t=e.find('input[name="all"]')[0].checked;e.find('input[name="actor"]').prop("checked",t)}(e))),e.on("change",'input[name="actor"]',(()=>function(e){const t=e.find('input[name="actor"]'),n=t.filter(":checked"),a=e.find('input[name="all"]');t.length===n.length?(a.prop("checked",!0).prop("indeterminate",!1),t.prop("checked",!0)):n.length?a.prop("checked",!1).prop("indeterminate",!0):(a.prop("checked",!1).prop("indeterminate",!1),t.prop("checked",!1))}(e)))},close:()=>[]},r=await Dialog.wait(n,void 0,{id:"pf2e-hero-actions-remove-actions"});if(!r.length)return a("templates.removeActions.noSelection");for(const e of r)await y(e,"heroActions",[]);i("templates.removeActions.removed")}async function J(){const e=l("dialogs/create-table.hbs"),t={yes:{label:G("create"),icon:'<i class="fas fa-border-all"></i>',callback:e=>({type:e.find('.window-content input[name="type"]:checked').val(),unique:"unique"===e.find('.window-content input[name="draw"]:checked').val()})},no:{label:G("cancel"),icon:'<i class="fas fa-times"></i>',callback:()=>null}},n={content:await renderTemplate(e,{i18n:G}),title:G("title"),buttons:t,default:"yes",close:()=>null},a=await Dialog.wait(n,void 0,{id:"pf2e-hero-actions-create-table"});a&&("default"===a.type?async function(e){let t=await M();if(t&&await Dialog.confirm({title:F("title"),content:F("content")})){const n=P(e);return await t.update(n),X(t,!0)}t=await async function(e=!0){const t=P(e,await fromUuid(E));return RollTable.create(t,{temporary:!1})}(e),await X(t)}(a.unique):async function(e){const t=await function(e=!0){const t=P(e);return RollTable.create(t,{temporary:!1})}(e);await X(t),t.sheet?.render(!0)}(a.unique))}async function X(e,t=!1){t&&await e.normalize(),await p("tableUUID",e.uuid)}async function W(e){e.preventDefault();const t=$(e.currentTarget).closest(".action"),n=t.find(".item-summary");if(!n.hasClass("loaded")){const e=t.attr("data-uuid"),a=await _(e);if(!a)return;const i=await TextEditor.enrichHTML(a.description,{async:!0});n.find(".item-description").html(i),n.addClass("loaded")}t.toggleClass("expanded")}function K(e){e.preventDefault();const t=$(e.currentTarget).closest(".action"),n=t.closest(".heroActions-list");t.toggleClass("discarded");const a=Number(n.attr("data-discard")??"0"),i=n.find(".action.discarded");n.toggleClass("discardable",i.length===a)}function V(){Object.values(ui.windows).forEach((e=>{e instanceof ActorSheet&&"character"===e.actor.type&&e.render(!0)}))}function Z(e){switch(e.type){case"trade-reject":if(e.sender.id!==game.user.id)return;T(e);break;case"trade-accept":if(!function(){if(!game.user.isGM)return!1;const e=game.users.find((e=>e.active&&e.isGM));return game.user===e}())return;w(e);break;case"trade-request":if(e.receiver.id!==game.user.id)return;!async function(e){const{sender:t,receiver:n}=e,a=game.actors.get(t.cid),i=game.actors.get(n.cid);if(!a||!i)return void C(e);let r=`<p>${o("trade-request.header",{sender:a.name,receiver:i.name})}</p>`;r+=`<p>${o("trade-request.give",{give:v(t.uuid)})}</p>`,r+=`<p>${o("trade-request.want",{want:v(n.uuid)})}</p>`,r+=`<p style="margin-bottom: 1em;">${o("trade-request.accept")}</p>`,await Dialog.confirm({title:o("trade-request.title"),content:await TextEditor.enrichHTML(r,{async:!0})})?A(e):function(e){e.sender.id!==game.user.id?m({...e,type:"trade-reject"}):T(e)}(e)}(e);break;case"trade-error":if(!e.users.includes(game.user.id))return;k(e.error)}}!function(n,a=!1){e||(e="pf2e-hero-actions"),t=a?"system":"module"}(),Hooks.on("renderCharacterSheetPF2e",(async function(e,t){const n=e.actor;!n.pack&&n.id&&game.actors.has(n.id)&&(await async function(e,t){const n=I(t),a=t.heroPoints.value-n.length,i=t.isOwner,r=c("templates.heroActions"),o=await renderTemplate(l("sheet.hbs"),{owner:i,list:n,canUse:a>=0&&i,canDraw:a>0&&i,canTrade:f("trade"),mustDiscard:a<0,diff:Math.abs(a),i18n:(e,{hash:t})=>r(e,t)});e.find(".sheet-body .sheet-content [data-tab=actions] .tab-content .actions-panels [data-tab=encounter] > .strikes-list:not(.skill-action-list)").first().after(o)}(t,n),function(e,t){const n=e.find(".tab.actions .heroActions-list");n.find("[data-action=draw]").on("click",(e=>async function(e,t){t.preventDefault(),R(e)}(t,e))),n.find("[data-action=expand]").on("click",W),n.find("[data-action=use]").on("click",(e=>async function(e,t){t.preventDefault();O(e,$(t.currentTarget).closest(".action").attr("data-uuid"))}(t,e))),n.find("[data-action=display]").on("click",(e=>async function(e,t){t.preventDefault();N(e,$(t.currentTarget).closest(".action").attr("data-uuid"))}(t,e))),n.find("[data-action=discard]").on("click",K),n.find("[data-action=discard-selected]").on("click",(()=>async function(e,t){q(e,t.find(".tab.actions .heroActions-list .action.discarded").toArray().map((e=>e.dataset.uuid)))}(t,e))),e.find("[data-action=hero-actions-trade]").on("click",(()=>B(t)))}(t,n))})),Hooks.once("init",(()=>{g({name:"tableUUID",type:String,default:"",config:!0}),g({name:"trade",type:Boolean,default:!1,config:!0,onChange:V}),g({name:"private",type:Boolean,default:!1,config:!0}),g({name:"migrated",type:Number,default:0})})),Hooks.once("ready",(async()=>{var t;t=Z,game.socket.on(`module.${e}`,t),s().api={getHeroActions:I,useHeroAction:O,getHeroActionDetails:_,drawHeroAction:L,drawHeroActions:R,sendActionToChat:N,discardHeroActions:q,tradeHeroAction:B},game.user.isGM&&(s().api.createTable=J,s().api.removeHeroActions=Y,await async function(){f("migrated")<1&&ChatMessage.create({content:o("migration.system-change"),whisper:game.user.id}),p("migrated",1)}())}))})();
//# sourceMappingURL=main.js.map