(()=>{"use strict";let e="",t="module";function n(){return t=e,game.modules.get(t);var t}function a(...t){return`${e}.settings.${t.join(".")}`}function i(...t){return`flags.${e}.${t.join("/")}`}function r(...n){return n=n.filter((e=>"string"==typeof e)),`${t}s/${e}/templates/${n.join("/")}`}function o(t){return game.settings.get(e,t)}function c(t){const n=t.name;t.scope=t.scope??"world",t.config=t.config??!1,t.config&&(t.name=a(n,"name"),t.hint=a(n,"hint")),Array.isArray(t.choices)&&(t.choices=t.choices.reduce(((e,t)=>(e[t]=a(n,"choices",t),e)),{})),game.settings.register(e,n,t)}function s(t){game.socket.emit(`module.${e}`,t)}function d(t,n,a){return t.getFlag(e,n)??a}function u(t,n,a){return t.setFlag(e,n,a)}function l(e,t,n,a){const i="string"==typeof t?t:"info",r="object"==typeof t?t:"object"==typeof n?n:void 0,o="boolean"==typeof t?t:"boolean"==typeof n?n:a??!1;ui.notifications.notify(m(e,r),i,{permanent:o})}function f(...e){const[t,n,a]=e;l(t,"warning",n,a)}function p(...e){const[t,n,a]=e;l(t,"info",n,a)}function g(...e){const[t,n,a]=e;l(t,"error",n,a)}function m(...t){let[n,a]=t;return n=`${e}.${n}`,a?game.i18n.format(n,a):game.i18n.localize(n)}function h(t){const n=(...e)=>m(`${t}.${e[0]}`,e[1]);return Object.defineProperties(n,{warn:{value:(...e)=>f(`${t}.${e[0]}`,e[1],e[2]),enumerable:!1,configurable:!1},info:{value:(...e)=>p(`${t}.${e[0]}`,e[1],e[2]),enumerable:!1,configurable:!1},error:{value:(...e)=>g(`${t}.${e[0]}`,e[1],e[2]),enumerable:!1,configurable:!1},has:{value:n=>function(t){return game.i18n.has(`${e}.${t}`,!1)}(`${t}.${n}`),enumerable:!1,configurable:!1},path:{value:n=>function(t){return`${e}.${t}`}(`${t}.${n}`),enumerable:!1,configurable:!1},template:{value:(e,{hash:t})=>n(e,t),enumerable:!1,configurable:!1}}),n}function v(e,t){return t?`@UUID[${e}]{${t}}`:`@UUID[${e}]`}async function y(e){const{sender:t,receiver:n}=e,a=game.actors.get(t.cid),i=game.actors.get(n.cid);if(!a||!i)return void A(e);const r=d(a,"heroActions")??[],o=d(i,"heroActions")??[],c=r.findIndex((e=>e.uuid===t.uuid)),s=o.findIndex((e=>e.uuid===n.uuid));if(-1===c||-1===s)return void A(e);const l=r.splice(c,1)[0],f=o.splice(s,1)[0];r.push(f),o.push(l),u(a,"heroActions",r),u(i,"heroActions",o);let p=`<div>${m("trade-success.offer",{offer:v(l.uuid)})}</div>`;p+=`<div>${m("trade-success.receive",{receive:v(f.uuid)})}</div>`,ChatMessage.create({flavor:`<h4 class="action">${m("trade-success.header",{name:i.name})}</h4>`,content:p,speaker:ChatMessage.getSpeaker({actor:a})})}async function b({receiver:e}){f("trade-rejected",{name:game.actors.get(e.cid).name},!0)}function w(e){g("trade-error")}function k(e){game.user.isGM?y(e):s({...e,type:"trade-accept"})}function A({sender:e,receiver:t},n="trade-error"){const a=new Set([e.id,t.id]);a.has(game.user.id)&&(a.delete(game.user.id),w()),a.size&&s({type:"trade-error",users:Array.from(a),error:n})}class Trade extends Application{_actor;_target;constructor(e){super({id:`pf2e-hero-actions-trade-${e.id}`}),this._actor=e}static get defaultOptions(){return mergeObject(super.defaultOptions,{title:m("templates.trade.title"),template:r("trade.hbs"),width:600,height:"auto"})}get actor(){return this._actor}get target(){return this._target}set target(e){e?e!==this._target&&(delete this.target?.apps?.[this.appId],this._target=e,this.render()):g("templates.trade.no-target")}getData(e){return mergeObject(super.getData(),{actor:this.actor,target:this.target,targets:game.actors.filter((e=>"character"===e.type&&e.id!==this.actor.id&&e.hasPlayerOwner)),actions:I(this.actor),targetActions:this.target?I(this.target):[],i18n:h("templates.trade")})}activateListeners(e){super.activateListeners(e),e.find('select[name="target"]').on("change",this.#e.bind(this)),e.find('[data-action="description"]').on("click",this.#t.bind(this)),e.find('[data-action="trade"]').on("click",this.#n.bind(this)),e.find('[data-action="cancel"]').on("click",(()=>this.close()))}render(e,t){return this.actor.apps[this.appId]=this,this.target&&(this.target.apps[this.appId]=this),super.render(e,t)}async close(e){await super.close(e),delete this.actor.apps?.[this.appId],delete this.target?.apps?.[this.appId]}#n(){if(!this.target)return void f("templates.trade.no-target");const e=this.element.find('[name="action"]:checked').val(),t=this.element.find('[name="targetAction"]:checked').val();if("string"!=typeof e||"string"!=typeof t)return void f("templates.trade.no-select");let n=function(e,t=!1){return t?game.users.find((t=>t.active&&t.character===e)):game.users.find((t=>t.character===e))}(this.target,!0)??function(e,t=!1){return t?game.users.find((t=>t.active&&e.testUserPermission(t,"OWNER"))):game.users.find((t=>e.testUserPermission(t,"OWNER")))}(this.target,!0)??game.users.find((e=>e.active&&e.isGM));var a;n?((a={sender:{id:game.user.id,cid:this.actor.id,uuid:e},receiver:{id:n.id,cid:this.target.id,uuid:t}}).receiver.id!==game.user.id?s({...a,type:"trade-request"}):k(a),this.close()):f("templates.trade.no-user")}async#t(e){const t=$(e.currentTarget).siblings("input").val(),n=await fromUuid(t);n?.sheet.render(!0)}#e(e){const t=e.currentTarget.value;this.target=game.actors.get(t)}}const T="pf2e.hero-point-deck",C="Compendium.pf2e.rollable-tables.zgZoI7h0XjjJrrNK",D="systems/pf2e/icons/features/feats/heroic-recovery.webp";async function U(e){if(!e)return;const t=await fromUuid(e);return t&&t instanceof RollTable?t:void 0}async function M(){return game.tables.find((e=>e.getFlag("core","sourceId")===C))}function I(e){const t=d(e,"heroActions")??[],n=game.packs.get(T);return t.map((e=>{if("string"!=typeof e)return e;if(!n)return;const t=n.index.get(e);return t?{name:t.name,uuid:`Compendium.${T}.${t._id}`}:void 0})).filter((e=>e))}async function S(e,t){const n=e.heroPoints.value;if(n<1)return f("use.noPoints");const a=I(e),r=a.findIndex((e=>e.uuid===t));if(-1===r)return;const o=await j(t);o||g("use.noDetails"),a.splice(r,1),o?(e.update({"system.resources.heroPoints.value":n-1,[i("heroActions")]:a}),ChatMessage.create({flavor:`<h4 class="action">${m("actions-use.header")}</h4>`,content:`<h2>${o.name}</h2>${o.description}`,speaker:ChatMessage.getSpeaker({actor:e})})):u(e,"heroActions",a)}async function j(e){const t=await fromUuid(e);if(!(t instanceof JournalEntry))return;const n=t.pages.contents[0];let a=n?.text.content;return a&&t.pack===T&&(a=a.replace(/^<p>/,"<p><strong>Trigger</strong> ")),a?{name:t.name,description:a}:void 0}function E(e,t){return u(e,"heroActions",t)}function O(e=!0,t){const n={name:m("table.name"),replacement:!e,img:D,description:m("table.description")};return t?mergeObject(duplicate(t._source),n):n}async function P(){const e=await async function(){return await async function(){return U(o("tableUUID"))}()??await M()??await async function(){return U(C)}()}();if(!e)return g("table.drawError",!0),null;if(!e.formula){if(!game.user.isGM)return g("table.noFormula",!0),null;if(e.compendium)return g("table.noFormulaCompendium",!0),null;await e.normalize()}!1===e.replacement&&(e.results.some((e=>!e.drawn))||await e.resetResults());const t=(await e.draw({displayChat:!1})).results[0];if(!t)return;const n=(a=t).type===CONST.TABLE_RESULT_TYPES.DOCUMENT?`${a.documentCollection}.${a.documentId}`:a.type===CONST.TABLE_RESULT_TYPES.COMPENDIUM?`Compendium.${a.documentCollection}.${a.documentId}`:void 0;var a;return n?{uuid:n,name:t.text}:void 0}async function H(e){const t=I(e),n=e.heroPoints.value-t.length,a=[];for(let e=0;e<n;e++){const e=await P();if(void 0!==e){if(null===e)return;t.push(e),a.push(e)}}if(!a.length)return;E(e,t);const i=a.map((e=>v(e.uuid,e.name)));ChatMessage.create({flavor:`<h4 class="action">${m("actions-draw.header",{nb:i.length})}</h4>`,content:i.map((e=>`<div>${e}</div>`)).join(""),speaker:ChatMessage.getSpeaker({actor:e})})}async function _(e,t){const n=await j(t);if(!n)return g("details.missing");ChatMessage.create({content:`<h2>${n.name}</h2>${n.description}`,speaker:ChatMessage.getSpeaker({actor:e})})}async function x(e,t){t="string"==typeof t?[t]:t;const n=I(e),a=[];for(const e of t){const t=n.findIndex((t=>t.uuid===e));-1!==t&&(a.push(n[t]),n.splice(t,1))}E(e,n);const i=a.map((e=>v(e.uuid,e.name)));ChatMessage.create({flavor:`<h4 class="action">${m("actions-discard.header",{nb:i.length})}</h4>`,content:i.map((e=>`<div>${e}</div>`)).join(""),speaker:ChatMessage.getSpeaker({actor:e})})}function q(e){const t=d(e,"heroActions");if(!t||!t.length)return void f("no-action");const n=t.length-e.heroPoints.value;n>0?f("no-points",{nb:n.toString()}):new Trade(e).render(!0)}const L=h("templates.createTable.choice"),N=h("templates.createTable.default.confirm"),R=h("templates.removeActions");async function F(){const e=r("dialogs/remove-actions.hbs"),t={yes:{label:R("remove"),icon:'<i class="fas fa-trash"></i>',callback:e=>e.find('input[name="actor"]:checked').toArray().map((e=>game.actors.get(e.value))).filter((e=>e))},no:{label:R("cancel"),icon:'<i class="fas fa-times"></i>',callback:()=>[]}},n={content:await renderTemplate(e,{actors:game.actors.filter((e=>"character"===e.type)),i18n:R}),title:R("title"),buttons:t,default:"yes",render:e=>{e.on("change",'input[name="all"]',(()=>function(e){const t=e.find('input[name="all"]')[0].checked;e.find('input[name="actor"]').prop("checked",t)}(e))),e.on("change",'input[name="actor"]',(()=>function(e){const t=e.find('input[name="actor"]'),n=t.filter(":checked"),a=e.find('input[name="all"]');t.length===n.length?(a.prop("checked",!0).prop("indeterminate",!1),t.prop("checked",!0)):n.length?a.prop("checked",!1).prop("indeterminate",!0):(a.prop("checked",!1).prop("indeterminate",!1),t.prop("checked",!1))}(e)))},close:()=>[]},a=await Dialog.wait(n,void 0,{id:"pf2e-hero-actions-remove-actions"});if(!a.length)return f("templates.removeActions.noSelection");for(const e of a)await u(e,"heroActions",[]);p("templates.removeActions.removed")}async function G(){const e=r("dialogs/create-table.hbs"),t={yes:{label:L("create"),icon:'<i class="fas fa-border-all"></i>',callback:e=>({type:e.find('.window-content input[name="type"]:checked').val(),unique:"unique"===e.find('.window-content input[name="draw"]:checked').val()})},no:{label:L("cancel"),icon:'<i class="fas fa-times"></i>',callback:()=>null}},n={content:await renderTemplate(e,{i18n:L}),title:L("title"),buttons:t,default:"yes",close:()=>null},a=await Dialog.wait(n,void 0,{id:"pf2e-hero-actions-create-table"});a&&("default"===a.type?async function(e){let t=await M();if(t&&await Dialog.confirm({title:N("title"),content:N("content")})){const n=O(e);return await t.update(n),z(t,!0)}t=await async function(e=!0){const t=O(e,await fromUuid(C));return RollTable.create(t,{temporary:!1})}(e),await z(t)}(a.unique):async function(e){const t=await function(e=!0){const t=O(e);return RollTable.create(t,{temporary:!1})}(e);await z(t),t.sheet?.render(!0)}(a.unique))}async function z(t,n=!1){var a;n&&await t.normalize(),await("tableUUID",a=t.uuid,game.settings.set(e,"tableUUID",a))}async function B(e){e.preventDefault();const t=$(e.currentTarget).closest(".action"),n=t.find(".item-summary");if(!n.hasClass("loaded")){const e=t.attr("data-uuid"),a=await j(e);if(!a)return;const i=await TextEditor.enrichHTML(a.description,{async:!0});n.find(".item-description").html(i),n.addClass("loaded")}t.toggleClass("expanded")}function J(e){e.preventDefault();const t=$(e.currentTarget).closest(".action"),n=t.closest(".heroActions-list");t.toggleClass("discarded");const a=Number(n.attr("data-discard")??"0"),i=n.find(".action.discarded");n.toggleClass("discardable",i.length===a)}function W(){Object.values(ui.windows).forEach((e=>{e instanceof ActorSheet&&"character"===e.actor.type&&e.render(!0)}))}function Y(e){switch(e.type){case"trade-reject":if(e.sender.id!==game.user.id)return;b(e);break;case"trade-accept":if(!function(){if(!game.user.isGM)return!1;const e=game.users.find((e=>e.active&&e.isGM));return game.user===e}())return;y(e);break;case"trade-request":if(e.receiver.id!==game.user.id)return;!async function(e){const{sender:t,receiver:n}=e,a=game.actors.get(t.cid),i=game.actors.get(n.cid);if(!a||!i)return void A(e);let r=`<p>${m("trade-request.header",{sender:a.name,receiver:i.name})}</p>`;r+=`<p>${m("trade-request.give",{give:v(t.uuid)})}</p>`,r+=`<p>${m("trade-request.want",{want:v(n.uuid)})}</p>`,r+=`<p style="margin-bottom: 1em;">${m("trade-request.accept")}</p>`,await Dialog.confirm({title:m("trade-request.title"),content:await TextEditor.enrichHTML(r,{async:!0})})?k(e):function(e){e.sender.id!==game.user.id?s({...e,type:"trade-reject"}):b(e)}(e)}(e);break;case"trade-error":if(!e.users.includes(game.user.id))return;w(e.error)}}!function(n,a=!1){e||(e="pf2e-hero-actions"),t=a?"system":"module"}(),Hooks.on("renderCharacterSheetPF2e",(async function(e,t){const n=e.actor;!n.pack&&n.id&&game.actors.has(n.id)&&(await async function(e,t){const n=I(t),a=t.heroPoints.value-n.length,i=t.isOwner,c=h("templates.heroActions"),s=await renderTemplate(r("sheet.hbs"),{owner:i,list:n,canUse:a>=0&&i,canDraw:a>0&&i,canTrade:o("trade"),mustDiscard:a<0,diff:Math.abs(a),i18n:(e,{hash:t})=>c(e,t)});e.find(".sheet-body .sheet-content [data-tab=actions] .tab-content .actions-panels [data-tab=encounter] > .strikes-list:not(.skill-action-list)").first().after(s)}(t,n),function(e,t){const n=e.find(".tab.actions .heroActions-list");n.find("[data-action=draw]").on("click",(e=>async function(e,t){t.preventDefault(),H(e)}(t,e))),n.find("[data-action=expand]").on("click",B),n.find("[data-action=use]").on("click",(e=>async function(e,t){t.preventDefault();S(e,$(t.currentTarget).closest(".action").attr("data-uuid"))}(t,e))),n.find("[data-action=display]").on("click",(e=>async function(e,t){t.preventDefault();_(e,$(t.currentTarget).closest(".action").attr("data-uuid"))}(t,e))),n.find("[data-action=discard]").on("click",J),n.find("[data-action=discard-selected]").on("click",(()=>async function(e,t){x(e,t.find(".tab.actions .heroActions-list .action.discarded").toArray().map((e=>e.dataset.uuid)))}(t,e))),e.find("[data-action=hero-actions-trade]").on("click",(()=>q(t)))}(t,n))})),Hooks.once("init",(()=>{c({name:"tableUUID",type:String,default:"",config:!0}),c({name:"trade",type:Boolean,default:!1,config:!0,onChange:W})})),Hooks.once("ready",(()=>{var t;t=Y,game.socket.on(`module.${e}`,t),n().api={getHeroActions:I,useHeroAction:S,getHeroActionDetails:j,drawHeroAction:P,drawHeroActions:H,sendActionToChat:_,discardHeroActions:x,tradeHeroAction:q},game.user.isGM&&(n().api.createTable=G,n().api.removeHeroActions=F)}))})();
//# sourceMappingURL=main.js.map