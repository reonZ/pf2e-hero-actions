(()=>{"use strict";let e="",t="module";function n(t){game.socket.emit(`module.${e}`,t)}function a(...t){return`${e}.settings.${t.join(".")}`}function i(...t){return`flags.${e}.${t.join("/")}`}function r(...n){return n=n.filter((e=>"string"==typeof e)),`${t}s/${e}/templates/${n.join("/")}`}function o(t){return game.settings.get(e,t)}function c(t){const n=t.name;t.scope=t.scope??"world",t.config=t.config??!1,t.config&&(t.name=a(n,"name"),t.hint=a(n,"hint")),Array.isArray(t.choices)&&(t.choices=t.choices.reduce(((e,t)=>(e[t]=a(n,"choices",t),e)),{})),game.settings.register(e,n,t)}function s(t,n,a){return t.getFlag(e,n)??a}function d(t,n,a){return t.setFlag(e,n,a)}function u(e,t,n,a){const i="string"==typeof t?t:"info",r="object"==typeof t?t:"object"==typeof n?n:void 0,o="boolean"==typeof t?t:"boolean"==typeof n?n:a??!1;ui.notifications.notify(g(e,r),i,{permanent:o})}function l(...e){const[t,n,a]=e;u(t,"warning",n,a)}function f(...e){const[t,n,a]=e;u(t,"info",n,a)}function p(...e){const[t,n,a]=e;u(t,"error",n,a)}function g(...t){let[n,a]=t;return n=`${e}.${n}`,a?game.i18n.format(n,a):game.i18n.localize(n)}function m(t){const n=(...e)=>g(`${t}.${e[0]}`,e[1]);return Object.defineProperties(n,{warn:{value:(...e)=>l(`${t}.${e[0]}`,e[1],e[2]),enumerable:!1,configurable:!1},info:{value:(...e)=>f(`${t}.${e[0]}`,e[1],e[2]),enumerable:!1,configurable:!1},error:{value:(...e)=>p(`${t}.${e[0]}`,e[1],e[2]),enumerable:!1,configurable:!1},has:{value:n=>function(t){return game.i18n.has(`${e}.${t}`,!1)}(`${t}.${n}`),enumerable:!1,configurable:!1},path:{value:n=>function(t){return`${e}.${t}`}(`${t}.${n}`),enumerable:!1,configurable:!1},template:{value:(e,{hash:t})=>n(e,t),enumerable:!1,configurable:!1}}),n}function h(e,t){return t?`@UUID[${e}]{${t}}`:`@UUID[${e}]`}const v="pf2e.hero-point-deck",b="Compendium.pf2e.rollable-tables.zgZoI7h0XjjJrrNK",y="systems/pf2e/icons/features/feats/heroic-recovery.webp";async function w(e){if(!e)return;const t=await fromUuid(e);return t&&t instanceof RollTable?t:void 0}async function k(){return game.tables.find((e=>e.getFlag("core","sourceId")===b))}function T(e){const t=s(e,"heroActions")??[],n=game.packs.get(v);return t.map((e=>{if("string"!=typeof e)return e;if(!n)return;const t=n.index.get(e);return t?{name:t.name,uuid:`Compendium.${v}.${t._id}`}:void 0})).filter((e=>e))}async function A(e,t){const n=e.heroPoints.value;if(n<1)return l("use.noPoints");const a=T(e),r=a.findIndex((e=>e.uuid===t));if(-1===r)return;const o=await C(t);o||p("use.noDetails"),a.splice(r,1),o?(e.update({"system.resources.heroPoints.value":n-1,[i("heroActions")]:a}),ChatMessage.create({flavor:`<h4 class="action">${g("actions-use.header")}</h4>`,content:`<h2>${o.name}</h2>${o.description}`,speaker:ChatMessage.getSpeaker({actor:e})})):d(e,"heroActions",a)}async function C(e){const t=await fromUuid(e);if(!(t instanceof JournalEntry))return;const n=t.pages.contents[0];let a=n?.text.content;return a&&t.pack===v&&(a=a.replace(/^<p>/,"<p><strong>Trigger</strong> ")),a?{name:t.name,description:a}:void 0}function D(e,t){return d(e,"heroActions",t)}function U(e=!0,t){const n={name:g("table.name"),replacement:!e,img:y,description:g("table.description")};return t?mergeObject(duplicate(t._source),n):n}async function M(){const e=await async function(){return await async function(){return w(o("tableUUID"))}()??await k()??await async function(){return w(b)}()}();if(!e)return p("table.drawError",!0),null;if(!e.formula){if(!game.user.isGM)return p("table.noFormula",!0),null;if(e.compendium)return p("table.noFormulaCompendium",!0),null;await e.normalize()}!1===e.replacement&&(e.results.some((e=>!e.drawn))||await e.resetResults());const t=(await e.draw({displayChat:!1})).results[0];if(!t)return;const n=(a=t).type===CONST.TABLE_RESULT_TYPES.DOCUMENT?`${a.documentCollection}.${a.documentId}`:a.type===CONST.TABLE_RESULT_TYPES.COMPENDIUM?`Compendium.${a.documentCollection}.${a.documentId}`:void 0;var a;return n?{uuid:n,name:t.text}:void 0}const I=m("templates.createTable.choice"),S=m("templates.createTable.default.confirm"),j=m("templates.removeActions");async function E(){const e=r("dialogs/remove-actions.hbs"),t={yes:{label:j("remove"),icon:'<i class="fas fa-trash"></i>',callback:e=>e.find('input[name="actor"]:checked').toArray().map((e=>game.actors.get(e.value))).filter((e=>e))},no:{label:j("cancel"),icon:'<i class="fas fa-times"></i>',callback:()=>[]}},n={content:await renderTemplate(e,{actors:game.actors.filter((e=>"character"===e.type)),i18n:j}),title:j("title"),buttons:t,default:"yes",render:e=>{e.on("change",'input[name="all"]',(()=>function(e){const t=e.find('input[name="all"]')[0].checked;e.find('input[name="actor"]').prop("checked",t)}(e))),e.on("change",'input[name="actor"]',(()=>function(e){const t=e.find('input[name="actor"]'),n=t.filter(":checked"),a=e.find('input[name="all"]');t.length===n.length?(a.prop("checked",!0).prop("indeterminate",!1),t.prop("checked",!0)):n.length?a.prop("checked",!1).prop("indeterminate",!0):(a.prop("checked",!1).prop("indeterminate",!1),t.prop("checked",!1))}(e)))},close:()=>[]},a=await Dialog.wait(n,void 0,{id:"pf2e-hero-actions-remove-actions"});if(!a.length)return l("templates.removeActions.noSelection");for(const e of a)await d(e,"heroActions",[]);f("templates.removeActions.removed")}async function O(){const e=r("dialogs/create-table.hbs"),t={yes:{label:I("create"),icon:'<i class="fas fa-border-all"></i>',callback:e=>({type:e.find('.window-content input[name="type"]:checked').val(),unique:"unique"===e.find('.window-content input[name="draw"]:checked').val()})},no:{label:I("cancel"),icon:'<i class="fas fa-times"></i>',callback:()=>null}},n={content:await renderTemplate(e,{i18n:I}),title:I("title"),buttons:t,default:"yes",close:()=>null},a=await Dialog.wait(n,void 0,{id:"pf2e-hero-actions-create-table"});a&&("default"===a.type?async function(e){let t=await k();if(t&&await Dialog.confirm({title:S("title"),content:S("content")})){const n=U(e);return await t.update(n),P(t,!0)}t=await async function(e=!0){const t=U(e,await fromUuid(b));return RollTable.create(t,{temporary:!1})}(e),await P(t)}(a.unique):async function(e){const t=await function(e=!0){const t=U(e);return RollTable.create(t,{temporary:!1})}(e);await P(t),t.sheet?.render(!0)}(a.unique))}async function P(t,n=!1){var a;n&&await t.normalize(),await("tableUUID",a=t.uuid,game.settings.set(e,"tableUUID",a))}async function _(e){const{sender:t,receiver:n}=e,a=game.actors.get(t.cid),i=game.actors.get(n.cid);if(!a||!i)return void L(e);const r=s(a,"heroActions")??[],o=s(i,"heroActions")??[],c=r.findIndex((e=>e.uuid===t.uuid)),u=o.findIndex((e=>e.uuid===n.uuid));if(-1===c||-1===u)return void L(e);const l=r.splice(c,1)[0],f=o.splice(u,1)[0];r.push(f),o.push(l),d(a,"heroActions",r),d(i,"heroActions",o);let p=`<div>${g("trade-success.offer",{offer:h(l.uuid)})}</div>`;p+=`<div>${g("trade-success.receive",{receive:h(f.uuid)})}</div>`,ChatMessage.create({flavor:`<h4 class="action">${g("trade-success.header",{name:i.name})}</h4>`,content:p,speaker:ChatMessage.getSpeaker({actor:a})})}async function x({receiver:e}){l("trade-rejected",{name:game.actors.get(e.cid).name},!0)}function q(e){p("trade-error")}function H(e){game.user.isGM?_(e):n({...e,type:"trade-accept"})}function L({sender:e,receiver:t},a="trade-error"){const i=new Set([e.id,t.id]);i.has(game.user.id)&&(i.delete(game.user.id),q()),i.size&&n({type:"trade-error",users:Array.from(i),error:a})}class Trade extends Application{_actor;_target;constructor(e){super({id:`pf2e-hero-actions-trade-${e.id}`}),this._actor=e}static get defaultOptions(){return mergeObject(super.defaultOptions,{title:g("templates.trade.title"),template:r("trade.hbs"),width:600,height:"auto"})}get actor(){return this._actor}get target(){return this._target}set target(e){e?e!==this._target&&(delete this.target?.apps?.[this.appId],this._target=e,this.render()):p("templates.trade.no-target")}getData(e){return mergeObject(super.getData(),{actor:this.actor,target:this.target,targets:game.actors.filter((e=>"character"===e.type&&e.id!==this.actor.id&&e.hasPlayerOwner)),actions:T(this.actor),targetActions:this.target?T(this.target):[],i18n:m("templates.trade")})}activateListeners(e){super.activateListeners(e),e.find('select[name="target"]').on("change",this.#e.bind(this)),e.find('[data-action="description"]').on("click",this.#t.bind(this)),e.find('[data-action="trade"]').on("click",this.#n.bind(this)),e.find('[data-action="cancel"]').on("click",(()=>this.close()))}render(e,t){return this.actor.apps[this.appId]=this,this.target&&(this.target.apps[this.appId]=this),super.render(e,t)}async close(e){await super.close(e),delete this.actor.apps?.[this.appId],delete this.target?.apps?.[this.appId]}#n(){if(!this.target)return void l("templates.trade.no-target");const e=this.element.find('[name="action"]:checked').val(),t=this.element.find('[name="targetAction"]:checked').val();if("string"!=typeof e||"string"!=typeof t)return void l("templates.trade.no-select");let a=function(e,t=!1){return t?game.users.find((t=>t.active&&t.character===e)):game.users.find((t=>t.character===e))}(this.target,!0)??function(e,t=!1){return t?game.users.find((t=>t.active&&e.testUserPermission(t,"OWNER"))):game.users.find((t=>e.testUserPermission(t,"OWNER")))}(this.target,!0)??game.users.find((e=>e.active&&e.isGM));var i;a?((i={sender:{id:game.user.id,cid:this.actor.id,uuid:e},receiver:{id:a.id,cid:this.target.id,uuid:t}}).receiver.id!==game.user.id?n({...i,type:"trade-request"}):H(i),this.close()):l("templates.trade.no-user")}async#t(e){const t=$(e.currentTarget).siblings("input").val(),n=await fromUuid(t);n?.sheet.render(!0)}#e(e){const t=e.currentTarget.value;this.target=game.actors.get(t)}}async function N(e){e.preventDefault();const t=$(e.currentTarget).closest(".action"),n=t.find(".item-summary");if(!n.hasClass("loaded")){const e=t.attr("data-uuid"),a=await C(e);if(!a)return;const i=await TextEditor.enrichHTML(a.description,{async:!0});n.find(".item-description").html(i),n.addClass("loaded")}t.toggleClass("expanded")}function R(e){e.preventDefault();const t=$(e.currentTarget).closest(".action"),n=t.closest(".heroActions-list");t.toggleClass("discarded");const a=Number(n.attr("data-discard")??"0"),i=n.find(".action.discarded");n.toggleClass("discardable",i.length===a)}function F(){Object.values(ui.windows).forEach((e=>{e instanceof ActorSheet&&"character"===e.actor.type&&e.render(!0)}))}function G(e){switch(e.type){case"trade-reject":if(e.sender.id!==game.user.id)return;x(e);break;case"trade-accept":if(!function(){if(!game.user.isGM)return!1;const e=game.users.find((e=>e.active&&e.isGM));return game.user===e}())return;_(e);break;case"trade-request":if(e.receiver.id!==game.user.id)return;!async function(e){const{sender:t,receiver:a}=e,i=game.actors.get(t.cid),r=game.actors.get(a.cid);if(!i||!r)return void L(e);let o=`<p>${g("trade-request.header",{sender:i.name,receiver:r.name})}</p>`;o+=`<p>${g("trade-request.give",{give:h(t.uuid)})}</p>`,o+=`<p>${g("trade-request.want",{want:h(a.uuid)})}</p>`,o+=`<p style="margin-bottom: 1em;">${g("trade-request.accept")}</p>`,await Dialog.confirm({title:g("trade-request.title"),content:await TextEditor.enrichHTML(o,{async:!0})})?H(e):function(e){e.sender.id!==game.user.id?n({...e,type:"trade-reject"}):x(e)}(e)}(e);break;case"trade-error":if(!e.users.includes(game.user.id))return;q(e.error)}}!function(n,a=!1){e||(e="pf2e-hero-actions"),t=a?"system":"module"}(),Hooks.on("renderCharacterSheetPF2e",(async function(e,t){const n=e.actor;!n.pack&&n.id&&game.actors.has(n.id)&&(await async function(e,t){const n=T(t),a=t.heroPoints.value-n.length,i=t.isOwner,c=m("templates.heroActions"),s=await renderTemplate(r("sheet.hbs"),{owner:i,list:n,canUse:a>=0&&i,canDraw:a>0&&i,canTrade:o("trade"),mustDiscard:a<0,diff:Math.abs(a),i18n:(e,{hash:t})=>c(e,t)});e.find(".sheet-body .sheet-content [data-tab=actions] .tab-content .actions-panels [data-tab=encounter] > .strikes-list:not(.skill-action-list)").first().after(s)}(t,n),function(e,t){const n=e.find(".tab.actions .heroActions-list");n.find("[data-action=draw]").on("click",(e=>async function(e,t){t.preventDefault();const n=T(e),a=e.heroPoints.value-n.length,i=[];for(let e=0;e<a;e++){const e=await M();if(void 0!==e){if(null===e)return;n.push(e),i.push(e)}}if(!i.length)return;D(e,n);const r=i.map((e=>h(e.uuid,e.name)));ChatMessage.create({flavor:`<h4 class="action">${g("actions-draw.header",{nb:r.length})}</h4>`,content:r.map((e=>`<div>${e}</div>`)).join(""),speaker:ChatMessage.getSpeaker({actor:e})})}(t,e))),n.find("[data-action=expand]").on("click",N),n.find("[data-action=use]").on("click",(e=>async function(e,t){t.preventDefault();A(e,$(t.currentTarget).closest(".action").attr("data-uuid"))}(t,e))),n.find("[data-action=display]").on("click",(e=>async function(e,t){t.preventDefault();const n=$(t.currentTarget).closest(".action").attr("data-uuid"),a=await C(n);if(!a)return p("details.missing");ChatMessage.create({content:`<h2>${a.name}</h2>${a.description}`,speaker:ChatMessage.getSpeaker({actor:e})})}(t,e))),n.find("[data-action=discard]").on("click",R),n.find("[data-action=discard-selected]").on("click",(()=>async function(e,t){const n=t.find(".tab.actions .heroActions-list .action.discarded").toArray().map((e=>e.dataset.uuid)),a=T(e),i=[];for(const e of n){const t=a.findIndex((t=>t.uuid===e));-1!==t&&(i.push(a[t]),a.splice(t,1))}D(e,a);const r=i.map((e=>h(e.uuid,e.name)));ChatMessage.create({flavor:`<h4 class="action">${g("actions-discard.header",{nb:r.length})}</h4>`,content:r.map((e=>`<div>${e}</div>`)).join(""),speaker:ChatMessage.getSpeaker({actor:e})})}(t,e))),e.find("[data-action=hero-actions-trade]").on("click",(()=>function(e){const t=s(e,"heroActions");if(!t||!t.length)return void l("no-action");const n=t.length-e.heroPoints.value;n>0?l("no-points",{nb:n.toString()}):new Trade(e).render(!0)}(t)))}(t,n))})),Hooks.once("init",(()=>{c({name:"tableUUID",type:String,default:"",config:!0}),c({name:"trade",type:Boolean,default:!1,config:!0,onChange:F})})),Hooks.once("ready",(()=>{var t,n;t=G,game.socket.on(`module.${e}`,t),game.user.isGM&&((n=e,game.modules.get(n)).api={createTable:O,removeHeroActions:E,getHeroActions:T,useHeroAction:A})}))})();
//# sourceMappingURL=main.js.map